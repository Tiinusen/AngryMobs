package InvulnerabilityBuff

import HashMap
import ClosureTimers
import HeroConstants
import initlater SoldierEntity
import BuffObjEditing

public let INVULNERABILITY_BUFF_OBJ = compiletime(createDummyBuffObject("Invulnerability", "This unit is invulnerability", Icons.dISBTNDivineShieldOff, Abilities.generalAuraTarget, AttachmentPoints.origin))

let buffId = INVULNERABILITY_BUFF_OBJ.abilId

abstract class InvulnerabilityBuff
	private static HashMap<SoldierEntity, CallbackSingle> _buffMap = new HashMap<SoldierEntity, CallbackSingle>()

	static function has(SoldierEntity soldier) returns bool
		return _buffMap.has(soldier)

	static function remove(SoldierEntity soldier)
		if _buffMap.has(soldier)
			destroy _buffMap.get(soldier)
			_buffMap.remove(soldier)
			soldier.getUnit().setInvulnerable(false)
		

	static function add(SoldierEntity soldier, real duration)
		if _buffMap.has(soldier)
			let cb = _buffMap.get(soldier)
			if cb != null
				destroy cb
		if not soldier.getUnit().hasAbility(buffId)
			soldier.getUnit().addAbility(buffId)
		soldier.getUnit().setInvulnerable(true)
		if duration > 0
			let cb = doAfter(duration) ->
				if _buffMap.has(soldier)
					_buffMap.remove(soldier)
					soldier.getUnit().removeAbility(buffId)
					soldier.getUnit().setInvulnerable(true)
			_buffMap.put(soldier, cb)
		else
			_buffMap.put(soldier, null)